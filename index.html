<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - NusaTask</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-6xl mx-auto mt-10 space-y-10">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">📊 Admin Panel - NusaTask</h1>

    <!-- Withdrawals -->
    <section class="bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-xl font-semibold mb-4">💸 Daftar Withdrawals</h2>
      <div id="withdrawals"></div>
    </section>

    <!-- Users -->
    <section class="bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">👤 Manajemen User</h2>
        <!-- Search box -->
        <input 
          type="text" 
          id="searchUser" 
          placeholder="Cari UID..." 
          class="px-3 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div id="users"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // 🔹 Config Firebase kamu
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let allUsers = {}; // simpan semua user global

    // =========================
    // Render Withdrawals
    // =========================
    function renderWithdrawals(data) {
      let html = `
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-blue-600 text-white">
              <th class="p-3 text-left">User</th>
              <th class="p-3 text-left">Jumlah</th>
              <th class="p-3 text-left">Metode</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Aksi</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const id in data) {
        const wd = data[id];
        const statusBadge = wd.status === "success"
          ? `<span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Sukses</span>`
          : wd.status === "pending"
          ? `<span class="px-3 py-1 text-xs font-semibold bg-yellow-100 text-yellow-700 rounded-full">Pending</span>`
          : `<span class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Ditolak</span>`;

        html += `
          <tr class="border-b hover:bg-gray-50 transition">
            <td class="p-3">${wd.uid}</td>
            <td class="p-3">Rp ${wd.amount.toLocaleString()}</td>
            <td class="p-3">${wd.method || "-"}</td>
            <td class="p-3">${statusBadge}</td>
            <td class="p-3 space-x-2">
              <button onclick="updateStatus('${id}','success')" class="px-3 py-1 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition">✔️ Approve</button>
              <button onclick="updateStatus('${id}','rejected')" class="px-3 py-1 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition">❌ Reject</button>
              <button onclick="deleteWD('${id}')" class="px-3 py-1 bg-gray-500 text-white rounded-lg shadow hover:bg-gray-600 transition">🗑️ Hapus</button>
            </td>
          </tr>
        `;
      }

      html += "</tbody></table>";
      document.getElementById("withdrawals").innerHTML = html;
    }

    // =========================
    // Render Users + Search
    // =========================
    function renderUsers(data, filter = "") {
      let html = `
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-purple-600 text-white">
              <th class="p-3 text-left">UID</th>
              <th class="p-3 text-left">Saldo</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Aksi</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const uid in data) {
        if (filter && !uid.toLowerCase().includes(filter.toLowerCase())) continue;

        const user = data[uid];
        const statusBadge = user.status === "banned"
          ? `<span class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Banned</span>`
          : `<span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Active</span>`;

        const actionBtn = user.status === "banned"
          ? `<button onclick="unbanUser('${uid}')" class="px-3 py-1 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition">🔓 Unban</button>`
          : `<button onclick="banUser('${uid}')" class="px-3 py-1 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition">🚫 Ban</button>`;

        html += `
          <tr class="border-b hover:bg-gray-50 transition">
            <td class="p-3">${uid}</td>
            <td class="p-3">Rp ${(user.saldo || 0).toLocaleString()}</td>
            <td class="p-3">${statusBadge}</td>
            <td class="p-3">${actionBtn}</td>
          </tr>
        `;
      }

      html += "</tbody></table>";
      document.getElementById("users").innerHTML = html;
    }

    // =========================
    // Firebase Actions
    // =========================
    window.updateStatus = (id, status) => {
      update(ref(db, "withdrawals/" + id), { status });
    };

    window.deleteWD = (id) => {
      remove(ref(db, "withdrawals/" + id));
    };

    window.banUser = (uid) => {
      update(ref(db, "users/" + uid), { status: "banned" });
    };

    window.unbanUser = (uid) => {
      update(ref(db, "users/" + uid), { status: "active" });
    };

    // =========================
    // Auth Check & Load Data
    // =========================
    onAuthStateChanged(auth, (user) => {
      if (user) {
        onValue(ref(db, "withdrawals"), (snapshot) => {
          document.getElementById("withdrawals").innerHTML = snapshot.exists()
            ? renderWithdrawals(snapshot.val())
            : "<p class='text-gray-500 text-center'>Belum ada data WD.</p>";
        });

        onValue(ref(db, "users"), (snapshot) => {
          if (snapshot.exists()) {
            allUsers = snapshot.val();
            renderUsers(allUsers);
          } else {
            document.getElementById("users").innerHTML = "<p class='text-gray-500 text-center'>Belum ada user terdaftar.</p>";
          }
        });
      } else {
        window.location.href = "/index.html";
      }
    });

    // =========================
    // Search Input Listener
    // =========================
    document.getElementById("searchUser").addEventListener("input", (e) => {
      const filter = e.target.value.trim();
      renderUsers(allUsers, filter);
    });
  </script>
</body>
</html>

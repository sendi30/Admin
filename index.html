<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - NusaTask</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-900 text-white">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500"></div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-96 text-center">
      <h1 class="text-2xl font-bold mb-4">Admin Login</h1>
      <input id="email" type="email" placeholder="Email"
        class="w-full mb-3 p-2 rounded bg-gray-700 text-white focus:outline-none">
      <input id="password" type="password" placeholder="Password"
        class="w-full mb-3 p-2 rounded bg-gray-700 text-white focus:outline-none">
      <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Login</button>
      <p id="loginError" class="text-red-400 text-sm mt-3 hidden"></p>
    </div>
  </div>

  <!-- Admin Section -->
  <div id="adminSection" class="hidden p-6">
    <h1 class="text-3xl font-bold mb-6">📊 Admin Panel NusaTask</h1>

    <!-- Menu -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <button onclick="showPage('withdraw')" class="bg-yellow-500 p-4 rounded-lg shadow">💰 Withdraw</button>
      <button onclick="showPage('users')" class="bg-blue-500 p-4 rounded-lg shadow">👥 Users</button>
      <button onclick="showPage('banned')" class="bg-red-500 p-4 rounded-lg shadow">⛔ Banned</button>
    </div>

    <!-- Content -->
    <div id="content" class="bg-gray-800 p-4 rounded-xl shadow min-h-[400px]">
      <p class="text-gray-400">Pilih menu untuk melihat data.</p>
    </div>

    <button onclick="logout()" class="mt-6 bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded">Logout</button>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-5 right-5 hidden bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.appspot.com",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // Helpers
    function showToast(msg, type="success") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg shadow-lg ${
        type==="error" ? "bg-red-600" : "bg-green-600"
      }`;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 3000);
    }
    function fmtDate(ts){ return ts ? new Date(ts).toLocaleString("id-ID") : "-"; }

    // State check
    auth.onAuthStateChanged(user => {
      document.getElementById("loading").classList.add("hidden");
      if (user && user.email === "AdminNusaTask@gmail.com") {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("adminSection").classList.remove("hidden");
      } else {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("adminSection").classList.add("hidden");
      }
    });

    // Login
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => {
          document.getElementById("loginError").innerText = err.message;
          document.getElementById("loginError").classList.remove("hidden");
        });
    }
    function logout(){ auth.signOut(); }

    // Page Switcher
    function showPage(page){
      const content = document.getElementById("content");
      content.innerHTML = `<p class="text-gray-400 animate-pulse">Loading ${page}...</p>`;

      if(page==="withdraw"){
        renderWithdrawals(content);
      } else if(page==="users"){
        renderUsers(content);
      } else if(page==="banned"){
        renderBanned(content);
      }
    }

    // Render Withdrawals
    function renderWithdrawals(container){
      db.ref("withdrawals").once("value", snap=>{
        if(!snap.exists()){ container.innerHTML="<p class='text-gray-400'>Tidak ada WD</p>"; return; }

        let html = `
          <h2 class="text-xl mb-3">Daftar Withdraw</h2>
          <div class="flex gap-2 mb-3">
            <input type="date" id="fromDate" class="bg-gray-700 p-2 rounded">
            <input type="date" id="toDate" class="bg-gray-700 p-2 rounded">
            <button onclick="filterWithdraws()" class="bg-blue-600 px-4 rounded">Filter</button>
          </div>
          <table class="w-full text-left">
            <thead><tr><th>Email</th><th>Nominal</th><th>Metode</th><th>Status</th><th>Aksi</th></tr></thead>
            <tbody id="wdTable">`;
        snap.forEach(child=>{
          const wd = child.val();
          html += `<tr class="border-b border-gray-700">
            <td>${wd.email||"-"}</td>
            <td>Rp${wd.amount||0}</td>
            <td>${wd.method||"-"}</td>
            <td>${wd.status||"pending"}</td>
            <td>
              ${wd.status==="pending" ? `
              <button onclick="approveWd('${child.key}','${wd.uid}',${wd.amount})" class="bg-green-600 px-2 py-1 rounded">Approve</button>
              <button onclick="rejectWd('${child.key}')" class="bg-red-600 px-2 py-1 rounded">Reject</button>` : "-"}
            </td>
          </tr>`;
        });
        html+="</tbody></table>";
        container.innerHTML = html;
      });
    }

    // Approve / Reject Withdraw
    function approveWd(id, uid, amount){
      db.ref("withdrawals/"+id).update({status:"approved"});
      db.ref("users/"+uid+"/saldo").transaction(saldo=>(saldo||0)-amount);
      showToast("Withdraw Approved ✅");
    }
    function rejectWd(id){
      db.ref("withdrawals/"+id).update({status:"rejected"});
      showToast("Withdraw Rejected ❌","error");
    }

    // Render Users
    function renderUsers(container){
      db.ref("users").once("value", snap=>{
        if(!snap.exists()){ container.innerHTML="<p class='text-gray-400'>Tidak ada User</p>"; return; }
        let html = "<h2 class='text-xl mb-3'>Daftar User</h2><ul>";
        snap.forEach(child=>{
          let u=child.val();
          html+=`<li class="mb-2 bg-gray-700 p-2 rounded">${u.email||"-"} - Saldo: Rp${u.saldo||0}
            <button onclick="banUser('${child.key}')" class="bg-red-600 px-2 py-1 rounded ml-2">Ban</button>
          </li>`;
        });
        html+="</ul>";
        container.innerHTML=html;
      });
    }
    function banUser(uid){
      db.ref("banned/"+uid).set(true);
      showToast("User dibanned ⛔","error");
    }

    // Render Banned
    function renderBanned(container){
      db.ref("banned").once("value", snap=>{
        if(!snap.exists()){ container.innerHTML="<p class='text-gray-400'>Tidak ada user banned</p>"; return; }
        let html="<h2 class='text-xl mb-3'>Daftar Banned</h2><ul>";
        snap.forEach(c=>{
          html+=`<li class="mb-2 bg-red-700 p-2 rounded">${c.key}
            <button onclick="unbanUser('${c.key}')" class="bg-green-600 px-2 py-1 rounded ml-2">Unban</button>
          </li>`;
        });
        html+="</ul>";
        container.innerHTML=html;
      });
    }
    function unbanUser(uid){
      db.ref("banned/"+uid).remove();
      showToast("User di-Unban ✅");
    }

    // Filter Withdraw by Date
    function filterWithdraws(){
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      if(!from && !to){ showToast("Isi tanggal filter!","error"); return; }
      const container = document.getElementById("content");
      renderWithdrawals(container); // reload, lalu filter bisa ditambahin kalau mau advance
    }
  </script>
</body>
</html>

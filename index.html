<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>NusaTask Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { min-height: 100vh; background: #0b0b0f; font-family: 'Inter', sans-serif; }
    .glass { background: rgba(23,23,28,.7); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="text-slate-200 flex items-center justify-center p-4">

  <!-- Login -->
  <div id="loginCard" class="glass w-full max-w-md rounded-xl p-6">
    <h1 class="text-xl font-bold mb-4 text-center">üîê NusaTask Admin</h1>
    <input id="email" type="email" placeholder="Email Admin"
      class="w-full mb-3 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2">
    <input id="password" type="password" placeholder="Password"
      class="w-full mb-4 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2">
    <button id="btnLogin" class="w-full py-2 rounded-lg bg-violet-600 hover:bg-violet-700">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="hidden w-full max-w-5xl space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold text-violet-300">‚ö° NusaTask Admin Panel</h2>
      <button onclick="auth.signOut()" class="px-3 py-1 bg-red-600 rounded">Logout</button>
    </div>

    <!-- Ringkasan -->
    <div class="grid grid-cols-3 gap-4">
      <div class="glass p-4 rounded-xl text-center">
        <p>Total User</p>
        <p id="totalUsers" class="text-2xl font-bold">0</p>
      </div>
      <div class="glass p-4 rounded-xl text-center">
        <p>Total Saldo</p>
        <p id="totalSaldo" class="text-2xl font-bold">Rp0</p>
      </div>
      <div class="glass p-4 rounded-xl text-center">
        <p>WD Pending</p>
        <p id="wdPending" class="text-2xl font-bold">0</p>
      </div>
    </div>

    <!-- Withdrawals -->
    <div class="glass p-6 rounded-xl">
      <h3 class="text-xl font-semibold mb-4">üì§ Withdrawals</h3>
      <div id="wdList" class="space-y-3"></div>
    </div>

    <!-- Users -->
    <div class="glass p-6 rounded-xl">
      <h3 class="text-xl font-semibold mb-4">üë• Users</h3>
      <div id="userList" class="space-y-3"></div>
    </div>
  </div>

  <script>
    // ========== Firebase ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCrFmaHbmL299cum51EtJIjt5NpukpTmho",
      authDomain: "penyimpanansaldo-280df.firebaseapp.com",
      databaseURL: "https://penyimpanansaldo-280df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "penyimpanansaldo-280df",
      storageBucket: "penyimpanansaldo-280df.firebasestorage.app",
      messagingSenderId: "659609775130",
      appId: "1:659609775130:web:bdd088ca5a877498c5b5a3",
      measurementId: "G-L4TW7E23H2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    // ========== Login ==========
    document.getElementById("btnLogin").onclick = () => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(cred => checkAdmin(cred.user.uid))
        .catch(err => alert("Login gagal: " + err.message));
    };

    // ========== Auto login dengan session ==========
    auth.onAuthStateChanged(user => {
      if (user) checkAdmin(user.uid);
    });

    // ========== Cek Admin ==========
    function checkAdmin(uid){
      db.ref("admins/"+uid).once("value").then(snap=>{
        if(snap.exists()){
          currentUser = uid;
          document.getElementById("loginCard").classList.add("hidden");
          document.getElementById("dash").classList.remove("hidden");
          loadDashboard();
        } else {
          alert("Bukan admin!");
          auth.signOut();
        }
      });
    }

    // ========== Dashboard ==========
    function loadDashboard(){
      // Users
      db.ref("users").on("value", snap=>{
        let totalUsers = 0, totalSaldo = 0;
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(c=>{
          totalUsers++;
          const u = c.val();
          totalSaldo += (u.saldo||0);

          const div = document.createElement("div");
          div.className = "flex justify-between items-center glass p-3 rounded-lg";
          div.innerHTML = `
            <div>
              <p class="font-medium">${u.email||"No Email"}</p>
              <p class="text-sm text-slate-400">Saldo: Rp${(u.saldo||0).toLocaleString("id-ID")} ‚Ä¢ Status: ${u.status||"active"}</p>
            </div>
            <div>
              <button onclick="setStatus('${c.key}','banned')" class="px-2 py-1 bg-red-500 rounded">Ban</button>
              <button onclick="setStatus('${c.key}','active')" class="px-2 py-1 bg-green-600 rounded">Unban</button>
            </div>
          `;
          list.appendChild(div);
        });
        document.getElementById("totalUsers").textContent = totalUsers;
        document.getElementById("totalSaldo").textContent = "Rp"+totalSaldo.toLocaleString("id-ID");
      });

      // Withdrawals
      db.ref("withdrawals").on("value", snap=>{
        let pending = 0;
        const list = document.getElementById("wdList");
        list.innerHTML = "";
        snap.forEach(c=>{
          const wd = c.val();
          if(wd.status==="pending") pending++;
          const div = document.createElement("div");
          div.className = "glass p-3 rounded-lg flex justify-between items-center";
          div.innerHTML = `
            <div>
              <p class="font-medium">Rp${wd.amount.toLocaleString("id-ID")} ‚Äì ${wd.method}</p>
              <p class="text-xs text-slate-400">${wd.account} ‚Ä¢ ${new Date(wd.createdAt).toLocaleString("id-ID")}</p>
              <p class="text-xs">User: ${wd.userId}</p>
            </div>
            <div class="space-x-1">
              <button onclick="setWDStatus('${c.key}','done')" class="px-2 py-1 bg-green-600 rounded">Done</button>
              <button onclick="setWDStatus('${c.key}','rejected')" class="px-2 py-1 bg-yellow-500 rounded">Reject</button>
              <button onclick="delWD('${c.key}')" class="px-2 py-1 bg-red-600 rounded">Hapus</button>
            </div>
          `;
          list.appendChild(div);
        });
        document.getElementById("wdPending").textContent = pending;
      });
    }

    // ========== Actions ==========
    function setStatus(uid, status){
      db.ref("users/"+uid+"/status").set(status);
    }
    function setWDStatus(id, status){
      db.ref("withdrawals/"+id+"/status").set(status);
    }
    function delWD(id){
      if(confirm("Yakin hapus?")){
        db.ref("withdrawals/"+id).remove();
      }
    }
  </script>
</body>
</html>